<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="原文出处:https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html 本文只为自己快速查看资料，原文出处如上。  2.1 MQTT控制报文的结构 Structure of an MQTT Control PacketMQTT控制报文的结构   Fixed header 固定报头，所有控制报文都包含     Vari">
<meta property="og:type" content="article">
<meta property="og:title" content="MTQQ 介绍">
<meta property="og:url" content="http://yoursite.com/2018/12/16/MTQQ-介绍/index.html">
<meta property="og:site_name" content="John 的技术博客">
<meta property="og:description" content="原文出处:https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html 本文只为自己快速查看资料，原文出处如上。  2.1 MQTT控制报文的结构 Structure of an MQTT Control PacketMQTT控制报文的结构   Fixed header 固定报头，所有控制报文都包含     Vari">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/12/16/MTQQ-介绍/figure0304.png">
<meta property="og:image" content="http://yoursite.com/2018/12/16/MTQQ-介绍/figure0306.png">
<meta property="og:updated_time" content="2019-01-03T13:54:29.768Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MTQQ 介绍">
<meta name="twitter:description" content="原文出处:https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html 本文只为自己快速查看资料，原文出处如上。  2.1 MQTT控制报文的结构 Structure of an MQTT Control PacketMQTT控制报文的结构   Fixed header 固定报头，所有控制报文都包含     Vari">
<meta name="twitter:image" content="http://yoursite.com/2018/12/16/MTQQ-介绍/figure0304.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/16/MTQQ-介绍/"/>





  <title>MTQQ 介绍 | John 的技术博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">John 的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/16/MTQQ-介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="John 的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MTQQ 介绍</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-16T14:51:14+08:00">
                2018-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>原文出处:<a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html" target="_blank" rel="noopener">https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html</a></p>
<p>本文只为自己快速查看资料，原文出处如上。</p>
</blockquote>
<h2 id="2-1-MQTT控制报文的结构-Structure-of-an-MQTT-Control-Packet"><a href="#2-1-MQTT控制报文的结构-Structure-of-an-MQTT-Control-Packet" class="headerlink" title="2.1 MQTT控制报文的结构 Structure of an MQTT Control Packet"></a>2.1 MQTT控制报文的结构 Structure of an MQTT Control Packet</h2><h5 id="MQTT控制报文的结构"><a href="#MQTT控制报文的结构" class="headerlink" title="MQTT控制报文的结构"></a>MQTT控制报文的结构</h5><table>
<thead>
<tr>
<th>Fixed header</th>
<th>固定报头，所有控制报文都包含</th>
</tr>
</thead>
<tbody>
<tr>
<td>Variable header</td>
<td>可变报头，部分控制报文包含</td>
</tr>
<tr>
<td>Payload</td>
<td>有效载荷，部分控制报文包含</td>
</tr>
</tbody>
</table>
<h2 id="2-2-固定报头-Fixed-header"><a href="#2-2-固定报头-Fixed-header" class="headerlink" title="2.2 固定报头 Fixed header"></a>2.2 固定报头 Fixed header</h2><h5 id="固定报头的格式"><a href="#固定报头的格式" class="headerlink" title="固定报头的格式"></a>固定报头的格式</h5><table><br>    <tr><br>        <td><center><strong>Bit</strong></center></td><br>        <td><center><strong>7</strong></center></td><br>        <td><center><strong>6</strong></center></td><br>        <td><center><strong>5</strong></center></td><br>        <td><center><strong>4</strong></center></td><br>        <td><center><strong>3</strong></center></td><br>        <td><center><strong>2</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>   <tr><br>           <td colspan="1"><center>byte 1</center></td><br>        <td colspan="4"><center>MQTT控制报文的类型</center></td><br>        <td colspan="4"><center>用于指定控制报文类型的标志位</center></td><br>   </tr><br>     <tr><br>           <td colspan="1"><center>byte 2…</center></td><br>        <td colspan="8"><center>剩余长度</center></td><br>   </tr><br></table>

<h3 id="2-2-1-MQTT控制报文的类型-MQTT-Control-Packet-type"><a href="#2-2-1-MQTT控制报文的类型-MQTT-Control-Packet-type" class="headerlink" title="2.2.1 MQTT控制报文的类型 MQTT Control Packet type"></a>2.2.1 MQTT控制报文的类型 MQTT Control Packet type</h3><h5 id="控制报文的类型"><a href="#控制报文的类型" class="headerlink" title="控制报文的类型"></a>控制报文的类型</h5><table>
<thead>
<tr>
<th><strong>名字</strong></th>
<th><strong>值</strong></th>
<th><strong>报文流动方向</strong></th>
<th style="text-align:left"><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Reserved</td>
<td>0</td>
<td>禁止</td>
<td style="text-align:left">保留</td>
</tr>
<tr>
<td>CONNECT</td>
<td>1</td>
<td>客户端到服务端</td>
<td style="text-align:left">客户端请求连接服务端</td>
</tr>
<tr>
<td>CONNACK</td>
<td>2</td>
<td>服务端到客户端</td>
<td style="text-align:left">连接报文确认</td>
</tr>
<tr>
<td>PUBLISH</td>
<td>3</td>
<td>两个方向都允许</td>
<td style="text-align:left">发布消息</td>
</tr>
<tr>
<td>PUBACK</td>
<td>4</td>
<td>两个方向都允许</td>
<td style="text-align:left">QoS 1消息发布收到确认</td>
</tr>
<tr>
<td>PUBREC</td>
<td>5</td>
<td>两个方向都允许</td>
<td style="text-align:left">发布收到（保证交付第一步）</td>
</tr>
<tr>
<td>PUBREL</td>
<td>6</td>
<td>两个方向都允许</td>
<td style="text-align:left">发布释放（保证交付第二步）</td>
</tr>
<tr>
<td>PUBCOMP</td>
<td>7</td>
<td>两个方向都允许</td>
<td style="text-align:left">QoS 2消息发布完成（保证交互第三步）</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td>8</td>
<td>客户端到服务端</td>
<td style="text-align:left">客户端订阅请求</td>
</tr>
<tr>
<td>SUBACK</td>
<td>9</td>
<td>服务端到客户端</td>
<td style="text-align:left">订阅请求报文确认</td>
</tr>
<tr>
<td>UNSUBSCRIBE</td>
<td>10</td>
<td>客户端到服务端</td>
<td style="text-align:left">客户端取消订阅请求</td>
</tr>
<tr>
<td>UNSUBACK</td>
<td>11</td>
<td>服务端到客户端</td>
<td style="text-align:left">取消订阅报文确认</td>
</tr>
<tr>
<td>PINGREQ</td>
<td>12</td>
<td>客户端到服务端</td>
<td style="text-align:left">心跳请求</td>
</tr>
<tr>
<td>PINGRESP</td>
<td>13</td>
<td>服务端到客户端</td>
<td style="text-align:left">心跳响应</td>
</tr>
<tr>
<td>DISCONNECT</td>
<td>14</td>
<td>客户端到服务端</td>
<td style="text-align:left">客户端断开连接</td>
</tr>
<tr>
<td>Reserved</td>
<td>15</td>
<td>禁止</td>
<td style="text-align:left">保留</td>
</tr>
</tbody>
</table>
<h3 id="2-2-2-标志-Flags"><a href="#2-2-2-标志-Flags" class="headerlink" title="2.2.2 标志 Flags"></a>2.2.2 标志 Flags</h3><h5 id="标志位-Flag-Bits"><a href="#标志位-Flag-Bits" class="headerlink" title="标志位 Flag Bits"></a>标志位 Flag Bits</h5><table>
<thead>
<tr>
<th><strong>控制报文</strong></th>
<th><strong>固定报头标志</strong></th>
<th><strong>Bit 3</strong></th>
<th><strong>Bit 2</strong></th>
<th><strong>Bit 1</strong></th>
<th><strong>Bit 0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CONNECT</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>CONNACK</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>PUBLISH</td>
<td>Used in MQTT 3.1.1</td>
<td>DUP1</td>
<td>QoS2</td>
<td>QoS2</td>
<td>RETAIN3</td>
</tr>
<tr>
<td>PUBACK</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>PUBREC</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>PUBREL</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>PUBCOMP</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>SUBACK</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>UNSUBSCRIBE</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>UNSUBACK</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>PINGREQ</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>PINGRESP</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>DISCONNECT</td>
<td>Reserved</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<ul>
<li>DUP1 =控制报文的重复分发标志</li>
<li>QoS2 = PUBLISH报文的服务质量等级</li>
<li>RETAIN3 = PUBLISH报文的保留标志</li>
</ul>
<h3 id="2-2-3-剩余长度-Remaining-Length"><a href="#2-2-3-剩余长度-Remaining-Length" class="headerlink" title="2.2.3 剩余长度 Remaining Length"></a>2.2.3 剩余长度 Remaining Length</h3><p>剩余长度（Remaining Length）表示当前报文剩余部分的字节数，包括可变报头和负载的数据。剩余长度不包括用于编码剩余长度字段本身的字节数。</p>
<p>剩余长度字段使用一个变长度编码方案，对小于128的值它使用单字节编码。更大的值按下面的方式处理。低7位有效位用于编码数据，最高有效位用于指示是否有更多的字节。因此每个字节可以编码128个数值和一个<em>延续位（continuation bit）</em>。剩余长度字段最大4个字节。</p>
<blockquote>
<p>  <strong>非规范评注</strong></p>
<p>例如，十进制数64会被编码为一个字节，数值是64，十六进制表示为0x40,。十进制数字321(=65+2*128)被编码为两个字节，最低有效位在前。第一个字节是 65+128=193。注意最高位为1表示后面至少还有一个字节。第二个字节是2。</p>
<p><strong>非规范评注</strong></p>
<p>这允许应用发送最大256MB(268,435,455)大小的控制报文。这个数值在报文中的表示是：0xFF,0xFF,0xFF,0x7F。</p>
<p><a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html#_Table_2.4_Size" target="_blank" rel="noopener">表格 2.4剩余长度字段的大小</a>展示了剩余长度字段所表示的值随字节增长。</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/ 最大四个字节，所以理论上最大控制报文大小是2^(4*8) = 4.294967e+9 bits，并且剩余长度字段最大四个字节，若是数据到达四个字节，则低字节的最高位则应该为0,此时表示无更多字节，所以实际上是(2^(4*8) /</span> <span class="number">2</span> = <span class="number">256</span> MB)。</span><br></pre></td></tr></table></figure>
<h5 id="表格-2-4剩余长度字段的大小-Size-of-Remaining-Length-field"><a href="#表格-2-4剩余长度字段的大小-Size-of-Remaining-Length-field" class="headerlink" title="表格 2.4剩余长度字段的大小 Size of Remaining Length field"></a>表格 2.4剩余长度字段的大小 Size of Remaining Length field</h5><table>
<thead>
<tr>
<th><strong>字节数</strong></th>
<th><strong>最小值</strong></th>
<th><strong>最大值</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0 (0x00)</td>
<td>127 (0x7F)</td>
</tr>
<tr>
<td>2</td>
<td>128 (0x80, 0x01)</td>
<td>16 383 (0xFF, 0x7F)</td>
</tr>
<tr>
<td>3</td>
<td>16 384 (0x80, 0x80, 0x01)</td>
<td>2 097 151 (0xFF, 0xFF, 0x7F)</td>
</tr>
<tr>
<td>4</td>
<td>2 097 152 (0x80, 0x80, 0x80, 0x01)</td>
<td>268 435 455 (0xFF, 0xFF, 0xFF, 0x7F)</td>
</tr>
</tbody>
</table>
<p>分别表示（每个字节的低7位用于编码数据，最高位是标志位）：</p>
<ul>
<li>1个字节时，从0(0x00)到127(0x7f)</li>
<li>2个字节时，从128(0x80,0x01)到16383(0Xff,0x7f)</li>
<li>3个字节时，从16384(0x80,0x80,0x01)到2097151(0xFF,0xFF,0x7F)</li>
<li>4个字节时，从2097152(0x80,0x80,0x80,0x01)到268435455(0xFF,0xFF,0xFF,0x7F)</li>
</ul>
<h2 id="2-3-可变报头-Variable-header"><a href="#2-3-可变报头-Variable-header" class="headerlink" title="2.3 可变报头 Variable header"></a>2.3 可变报头 Variable header</h2><h5 id="图例-2-3-报文标识符字节-Packet-Identifier-bytes"><a href="#图例-2-3-报文标识符字节-Packet-Identifier-bytes" class="headerlink" title="图例 2.3 -报文标识符字节 Packet Identifier bytes"></a>图例 2.3 -报文标识符字节 Packet Identifier bytes</h5><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong> - <strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
</tr>
</tbody>
</table>
<p>很多控制报文的可变报头部分包含一个两字节的报文标识符字段。这些报文是PUBLISH（QoS &gt; 0时）， PUBACK，PUBREC，PUBREL，PUBCOMP，SUBSCRIBE, SUBACK，UNSUBSCIBE，UNSUBACK。</p>
<p>SUBSCRIBE，UNSUBSCRIBE和PUBLISH（QoS大于0）控制报文<strong>必须</strong>包含一个非零的16位报文标识符（Packet Identifier）[MQTT-2.3.1-1]。客户端每次发送一个新的这些类型的报文时都<strong>必须</strong>分配一个当前未使用的报文标识符 [MQTT-2.3.1-2]。如果一个客户端要重发这个特殊的控制报文，在随后重发那个报文时，它<strong>必须</strong>使用相同的标识符。当客户端处理完这个报文对应的确认后，这个报文标识符就释放可重用。QoS 1的PUBLISH对应的是PUBACK，QoS 2的PUBLISH对应的是PUBCOMP，与SUBSCRIBE或UNSUBSCRIBE对应的分别是SUBACK或UNSUBACK [MQTT-2.3.1-3]。发送一个QoS 0的PUBLISH报文时，相同的条件也适用于服务端 [MQTT-2.3.1-4]。</p>
<p>QoS等于0的PUBLISH报文<strong>不能</strong>包含报文标识符 [MQTT-2.3.1-5]。</p>
<p>PUBACK, PUBREC, PUBREL报文<strong>必须</strong>包含与最初发送的PUBLISH报文相同的报文标识符 [MQTT-2.3.1-6]。类似地，SUBACK和UNSUBACK<strong>必须</strong>包含在对应的SUBSCRIBE和UNSUBSCRIBE报文中使用的报文标识符 [MQTT-2.3.1-7]。</p>
<h5 id="表格-2-5-包含报文标识符的控制报文-Control-Packets-that-contain-a-Packet-Identifier"><a href="#表格-2-5-包含报文标识符的控制报文-Control-Packets-that-contain-a-Packet-Identifier" class="headerlink" title="表格 2.5 -包含报文标识符的控制报文 Control Packets that contain a Packet Identifier"></a>表格 2.5 -包含报文标识符的控制报文 Control Packets that contain a Packet Identifier</h5><table>
<thead>
<tr>
<th><strong>控制报文</strong></th>
<th><strong>报文标识符字段</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CONNECT</td>
<td>不需要</td>
</tr>
<tr>
<td>CONNACK</td>
<td>不需要</td>
</tr>
<tr>
<td>PUBLISH</td>
<td>需要（如果QoS &gt; 0）</td>
</tr>
<tr>
<td>PUBACK</td>
<td>需要</td>
</tr>
<tr>
<td>PUBREC</td>
<td>需要</td>
</tr>
<tr>
<td>PUBREL</td>
<td>需要</td>
</tr>
<tr>
<td>PUBCOMP</td>
<td>需要</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td>需要</td>
</tr>
<tr>
<td>SUBACK</td>
<td>需要</td>
</tr>
<tr>
<td>UNSUBSCRIBE</td>
<td>需要</td>
</tr>
<tr>
<td>UNSUBACK</td>
<td>需要</td>
</tr>
<tr>
<td>PINGREQ</td>
<td>不需要</td>
</tr>
<tr>
<td>PINGRESP</td>
<td>不需要</td>
</tr>
<tr>
<td>DISCONNECT</td>
<td>不需要</td>
</tr>
</tbody>
</table>
<p>客户端和服务端彼此独立地分配报文标识符。因此，客户端服务端组合使用相同的报文标识符可以实现并发的消息交换。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>客户端发送标识符为0x1234的PUBLISH报文，它有可能会在收到那个报文的PUBACK之前，先收到服务端发送的另一个不同的但是报文标识符也为0x1234的PUBLISH报文。</p>
<table>
<thead>
<tr>
<th>Client</th>
<th>Server</th>
</tr>
</thead>
<tbody>
<tr>
<td>PUBLISH</td>
<td>Packet Identifier=0x1234—</td>
</tr>
<tr>
<td>–PUBLISH</td>
<td>Packet Identifier=0x1234</td>
</tr>
<tr>
<td>PUBACK</td>
<td>Packet Identifier=0x1234—</td>
</tr>
<tr>
<td>–PUBACK</td>
<td>Packet Identifier=0x1234</td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="2-4-有效载荷-Payload"><a href="#2-4-有效载荷-Payload" class="headerlink" title="2.4 有效载荷 Payload"></a>2.4 有效载荷 Payload</h2><p>某些MQTT控制报文在报文的最后部分包含一个有效载荷，这将在第三章论述。对于<strong>PUBLISH来说有效载荷就是应用消息</strong>。</p>
<h5 id="表格-2-6-–-包含有效载荷的控制报文-Control-Packets-that-contain-a-Payload"><a href="#表格-2-6-–-包含有效载荷的控制报文-Control-Packets-that-contain-a-Payload" class="headerlink" title="表格 2.6 – 包含有效载荷的控制报文 Control Packets that contain a Payload"></a>表格 2.6 – 包含有效载荷的控制报文 Control Packets that contain a Payload</h5><table>
<thead>
<tr>
<th><strong>控制报文</strong></th>
<th><strong>有效载荷</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CONNECT</td>
<td>需要</td>
</tr>
<tr>
<td>CONNACK</td>
<td>不需要</td>
</tr>
<tr>
<td>PUBLISH</td>
<td>可选</td>
</tr>
<tr>
<td>PUBACK</td>
<td>不需要</td>
</tr>
<tr>
<td>PUBREC</td>
<td>不需要</td>
</tr>
<tr>
<td>PUBREL</td>
<td>不需要</td>
</tr>
<tr>
<td>PUBCOMP</td>
<td>不需要</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td>需要</td>
</tr>
<tr>
<td>SUBACK</td>
<td>需要</td>
</tr>
<tr>
<td>UNSUBSCRIBE</td>
<td>需要</td>
</tr>
<tr>
<td>UNSUBACK</td>
<td>不需要</td>
</tr>
<tr>
<td>PINGREQ</td>
<td>不需要</td>
</tr>
<tr>
<td>PINGRESP</td>
<td>不需要</td>
</tr>
<tr>
<td>DISCONNECT</td>
<td>不需要</td>
</tr>
</tbody>
</table>
<h2 id="3-1-CONNECT-–-连接服务端"><a href="#3-1-CONNECT-–-连接服务端" class="headerlink" title="3.1 CONNECT – 连接服务端"></a>3.1 CONNECT – 连接服务端</h2><p>客户端到服务端的网络连接建立后，客户端发送给服务端的第一个报文<strong>必须</strong>是CONNECT报文 [MQTT-3.1.0-1]。</p>
<p>在一个网络连接上，客户端只能发送一次CONNECT报文。服务端<strong>必须</strong>将客户端发送的第二个CONNECT报文当作协议违规处理并断开客户端的连接 [MQTT-3.1.0-2]。有关错误处理的信息请查看4.8节。</p>
<p><strong>有效载荷包含一个或多个编码的字段。包括客户端的唯一标识符，Will主题，Will消息，用户名和密码</strong>。除了客户端标识之外，其它的字段都是可选的，基于标志位来决定可变报头中是否需要包含这些字段。</p>
<h3 id="3-1-1-固定报头-Fixed-header"><a href="#3-1-1-固定报头-Fixed-header" class="headerlink" title="3.1.1 固定报头 Fixed header"></a>3.1.1 固定报头 Fixed header</h3><h5 id="图例-3-1-–CONNECT报文的固定报头"><a href="#图例-3-1-–CONNECT报文的固定报头" class="headerlink" title="图例 3.1 –CONNECT报文的固定报头"></a>图例 3.1 –CONNECT报文的固定报头</h5><table><br>    <tr><br>        <td><center><strong>Bit</strong></center></td><br>        <td><center><strong>7</strong></center></td><br>        <td><center><strong>6</strong></center></td><br>        <td><center><strong>5</strong></center></td><br>        <td><center><strong>4</strong></center></td><br>        <td><center><strong>3</strong></center></td><br>        <td><center><strong>2</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>   <tr><br>           <td colspan="1"><center>byte 1</center></td><br>        <td colspan="4"><center>MQTT报文类型 (2)</center></td><br>        <td colspan="4"><center>Reserved 保留位</center></td><br>   </tr><br>    <tr><br>           <td><center><strong> </strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>     <tr><br>           <td colspan="1"><center>byte 2…</center></td><br>        <td colspan="8"><center>剩余长度</center></td><br>   </tr><br></table>

<h3 id="剩余长度字段"><a href="#剩余长度字段" class="headerlink" title="剩余长度字段"></a><strong>剩余长度字段</strong></h3><p>剩余长度等于<strong>可变报头的长度（10字节</strong>）加上有效载荷的长度。编码方式见 2.2.3节的说明。</p>
<h3 id="3-1-2-可变报头-Variable-header"><a href="#3-1-2-可变报头-Variable-header" class="headerlink" title="3.1.2 可变报头 Variable header"></a>3.1.2 可变报头 Variable header</h3><p>CONNECT报文的可变报头按下列次序包含四个字段：<strong>协议名（Protocol Name），协议级别（Protocol Level），连接标志（Connect Flags）和保持连接（Keep Alive）</strong>。</p>
<h4 id="协议名-Protocol-Name"><a href="#协议名-Protocol-Name" class="headerlink" title="协议名 Protocol Name"></a>协议名 Protocol Name</h4><h5 id="图例-3-2-协议名字节构成"><a href="#图例-3-2-协议名字节构成" class="headerlink" title="图例 3.2 -协议名字节构成"></a>图例 3.2 -协议名字节构成</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>协议名</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 1</td>
<td>长度 MSB (0)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>长度 LSB (4)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 3</td>
<td>‘M’</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>byte 4</td>
<td>‘Q’</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>byte 5</td>
<td>‘T’</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 6</td>
<td>‘T’</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>协议名是表示协议名 <em>MQTT</em> 的UTF-8编码的字符串。MQTT规范的后续版本不会改变这个字符串的偏移和长度。</p>
<h4 id="协议级别-Protocol-Level"><a href="#协议级别-Protocol-Level" class="headerlink" title="协议级别 Protocol Level"></a>协议级别 Protocol Level</h4><h5 id="图例-3-3-Protocol-Level-byte协议级别字节构成"><a href="#图例-3-3-Protocol-Level-byte协议级别字节构成" class="headerlink" title="图例 3.3 - Protocol Level byte协议级别字节构成"></a>图例 3.3 - Protocol Level byte协议级别字节构成</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>协议级别</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 7</td>
<td>Level(4)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<h4 id="连接标志-Connect-Flags"><a href="#连接标志-Connect-Flags" class="headerlink" title="连接标志 Connect Flags"></a>连接标志 Connect Flags</h4><p>连接标志字节包含一些用于指定MQTT连接行为的参数。它还指出有效载荷中的字段是否存在。</p>
<h5 id="图例-3-4-连接标志位"><a href="#图例-3-4-连接标志位" class="headerlink" title="图例 3.4 -连接标志位"></a>图例 3.4 -连接标志位</h5><p><img src="/2018/12/16/MTQQ-介绍/figure0304.png" alt="figure-3.4"></p>
<p>服务端<strong>必须</strong>验证CONNECT控制报文的保留标志位（第0位）是否为0，如果不为0必须断开客户端连接 [MQTT-3.1.2-3]。</p>
<h4 id="清理会话-Clean-Session"><a href="#清理会话-Clean-Session" class="headerlink" title="清理会话 Clean Session"></a>清理会话 Clean Session</h4><p><strong>位置：</strong>连接标志字节的第1位</p>
<p>这个二进制位指定了会话状态的处理方式。</p>
<p>客户端和服务端可以保存会话状态，以支持跨网络连接的可靠消息传输。这个标志位用于控制会话状态的生存时间。</p>
<p>如果清理会话（CleanSession）标志被设置为0，服务端<strong>必须</strong>基于当前会话（使用客户端标识符识别）的状态恢复与客户端的通信。如果没有与这个客户端标识符关联的会话，服务端<strong>必须</strong>创建一个新的会话。在连接断开之后，当连接断开后，客户端和服务端<strong>必须</strong>保存会话信息 [MQTT-3.1.2-4]。当清理会话标志为0的会话连接断开之后，服务端<strong>必须</strong>将之后的QoS 1和QoS 2级别的消息保存为会话状态的一部分，如果这些消息匹配断开连接时客户端的任何订阅 [<a href="https://tools.oasis-open.org/issues/browse/MQTT-3" target="_blank" rel="noopener">MQTT-3</a>.1.2-5]。服务端也<strong>可以</strong>保存满足相同条件的QoS 0级别的消息。</p>
<p>如果清理会话（CleanSession）标志被设置为1，客户端和服务端<strong>必须</strong>丢弃之前的任何会话并开始一个新的会话。会话仅持续和网络连接同样长的时间。与这个会话关联的状态数据<strong>不能</strong>被任何之后的会话重用 [MQTT-3.1.2-6]。</p>
<p>客户端的会话状态包括：</p>
<ul>
<li>已经发送给服务端，但是还没有完成确认的QoS 1和QoS 2级别的消息</li>
<li>已从服务端接收，但是还没有完成确认的QoS 2级别的消息。</li>
</ul>
<p>服务端的会话状态包括：</p>
<ul>
<li>会话是否存在，即使会话状态的其它部分都是空。</li>
<li>客户端的订阅信息。</li>
<li>已经发送给客户端，但是还没有完成确认的QoS 1和QoS 2级别的消息。</li>
<li>即将传输给客户端的QoS 1和QoS 2级别的消息。</li>
<li>已从客户端接收，但是还没有完成确认的QoS 2级别的消息。</li>
<li>可选，准备发送给客户端的QoS 0级别的消息。</li>
</ul>
<p>保留消息不是服务端会话状态的一部分，会话终止时<strong>不能</strong>删除保留消息 [MQTT-3.1.2.7]。</p>
<p>有关状态存储的限制和细节见第 4.1节。</p>
<p>当清理会话标志被设置为1时，客户端和服务端的状态删除不需要是原子操作。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>为了确保在发生故障时状态的一致性，客户端应该使用会话状态标志1重复请求连接，直到连接成功。</p>
<p><strong>非规范评注</strong></p>
<p>一般来说，客户端连接时总是将清理会话标志设置为0或1，并且不交替使用两种值。这个选择取决于具体的应用。清理会话标志设置为1的客户端不会收到旧的应用消息，而且在每次连接成功后都需要重新订阅任何相关的主题。清理会话标志设置为0的客户端会收到所有在它连接断开期间发布的QoS 1和QoS 2级别的消息。因此，要确保不丢失连接断开期间的消息，需要使用QoS 1或 QoS 2级别，同时将清理会话标志设置为0。</p>
<p><strong>非规范评注</strong></p>
<p>清理会话标志0的客户端连接时，它请求服务端在连接断开后保留它的MQTT会话状态。如果打算在之后的某个时间点重连到这个服务端，客户端连接应该只使用清理会话标志0。当客户端决定之后不再使用这个会话时，应该将清理会话标志设置为1最后再连接一次，然后断开连接。</p>
</blockquote>
<h4 id="遗嘱标志-Will-Flag"><a href="#遗嘱标志-Will-Flag" class="headerlink" title="遗嘱标志 Will Flag"></a>遗嘱标志 Will Flag</h4><p><strong>位置：</strong>连接标志的第2位。</p>
<p>遗嘱标志（Will Flag）被设置为1，表示如果连接请求被接受了，遗嘱（Will Message）消息<strong>必须</strong>被存储在服务端并且与这个网络连接关联。之后网络连接关闭时，服务端<strong>必须</strong>发布这个遗嘱消息，除非服务端收到DISCONNECT报文时删除了这个遗嘱消息 [MQTT-3.1.2-8] 。</p>
<p>遗嘱消息发布的条件，包括但不限于：</p>
<ul>
<li>服务端检测到了一个I/O错误或者网络故障。</li>
<li>客户端在保持连接（Keep Alive）的时间内未能通讯。</li>
<li>客户端没有先发送DISCONNECT报文直接关闭了网络连接。</li>
<li>由于协议错误服务端关闭了网络连接。</li>
</ul>
<p>如果遗嘱标志被设置为1，连接标志中的Will QoS和Will Retain字段会被服务端用到，同时有效载荷中<strong>必须</strong>包含Will Topic和Will Message字段 [MQTT-3.1.2-9]。</p>
<p>一旦被发布或者服务端收到了客户端发送的DISCONNECT报文，遗嘱消息就<strong>必须</strong>从存储的会话状态中移除 [MQTT-3.1.2-10]。</p>
<p>如果遗嘱标志被设置为0，连接标志中的Will QoS和Will Retain字段<strong>必须</strong>设置为0，并且有效载荷中<strong>不能</strong>包含Will Topic和Will Message字段 [MQTT-3.1.2-11]。</p>
<p>如果遗嘱标志被设置为0，网络连接断开时，<strong>不能</strong>发送遗嘱消息 [MQTT-3.1.2-12]。</p>
<p>服务端应该迅速发布遗嘱消息。在关机或故障的情况下，服务端可以推迟遗嘱消息的发布直到之后的重启。如果发生了这种情况，在服务器故障和遗嘱消息被发布之间可能会有一个延迟。</p>
<h4 id="遗嘱QoS-Will-QoS"><a href="#遗嘱QoS-Will-QoS" class="headerlink" title="遗嘱QoS Will QoS"></a>遗嘱QoS Will QoS</h4><p><strong>位置：</strong>连接标志的第4和第3位。</p>
<p>这两位用于指定发布遗嘱消息时使用的服务质量等级。</p>
<p>如果遗嘱标志被设置为0，遗嘱QoS也<strong>必须</strong>设置为0(0x00) [MQTT-3.1.2-13]。</p>
<p>如果遗嘱标志被设置为1，遗嘱QoS的值可以等于0(0x00)，1(0x01)，2(0x02)。它的值<strong>不能</strong>等于3 [MQTT-3.1.2-14]。</p>
<h4 id="遗嘱保留-Will-Retain"><a href="#遗嘱保留-Will-Retain" class="headerlink" title="遗嘱保留 Will Retain"></a>遗嘱保留 Will Retain</h4><p><strong>位置：</strong>连接标志的第5位。</p>
<p>如果遗嘱消息被发布时需要保留，需要指定这一位的值。</p>
<p>如果遗嘱标志被设置为0，遗嘱保留（Will Retain）标志也<strong>必须</strong>设置为0 [MQTT-3.1.2-15]。</p>
<p>如果遗嘱标志被设置为1：</p>
<ul>
<li>如果遗嘱保留被设置为0，服务端<strong>必须</strong>将遗嘱消息当作非保留消息发布 [MQTT-3.1.2-16]。</li>
<li>如果遗嘱保留被设置为1，服务端<strong>必须</strong>将遗嘱消息当作保留消息发布 [MQTT-3.1.2-17]。</li>
</ul>
<h4 id="用户名标志-User-Name-Flag"><a href="#用户名标志-User-Name-Flag" class="headerlink" title="用户名标志 User Name Flag"></a>用户名标志 User Name Flag</h4><p><strong>位置：</strong>连接标志的第7位。</p>
<p>如果用户名（User Name）标志被设置为0，有效载荷中<strong>不能</strong>包含用户名字段 [MQTT-3.1.2-18]。</p>
<p>如果用户名（User Name）标志被设置为1，有效载荷中<strong>必须</strong>包含用户名字段 [MQTT-3.1.2-19]。</p>
<h4 id="密码标志-Password-Flag"><a href="#密码标志-Password-Flag" class="headerlink" title="密码标志 Password Flag"></a>密码标志 Password Flag</h4><p><strong>位置：</strong>连接标志的第6位。</p>
<p>如果密码（Password）标志被设置为0，有效载荷中<strong>不能</strong>包含密码字段 [MQTT-3.1.2-20]。</p>
<p>如果密码（Password）标志被设置为1，有效载荷中<strong>必须</strong>包含密码字段 [MQTT-3.1.2-21]。</p>
<p>如果用户名标志被设置为0，密码标志也<strong>必须</strong>设置为0 [MQTT-3.1.2-22]。</p>
<h4 id="保持连接-Keep-Alive"><a href="#保持连接-Keep-Alive" class="headerlink" title="保持连接 Keep Alive"></a>保持连接 Keep Alive</h4><h5 id="图例-3-5保持连接字节"><a href="#图例-3-5保持连接字节" class="headerlink" title="图例 3.5保持连接字节"></a>图例 3.5保持连接字节</h5><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>byte 9</td>
<td>保持连接 Keep Alive MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 10</td>
<td>保持连接 Keep Alive LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>保持连接（Keep Alive）是一个以秒为单位的时间间隔，表示为一个16位的字，它是指在客户端传输完成一个控制报文的时刻到发送下一个报文的时刻，两者之间允许空闲的最大时间间隔。客户端负责保证控制报文发送的时间间隔不超过保持连接的值。如果没有任何其它的控制报文可以发送，客户端<strong>必须</strong>发送一个PINGREQ报文 [MQTT-3.1.2-23]。</p>
<p>不管保持连接的值是多少，客户端任何时候都可以发送PINGREQ报文，并且使用PINGRESP报文判断网络和服务端的活动状态。</p>
<p>如果保持连接的值非零，并且服务端在一点五倍的保持连接时间内没有收到客户端的控制报文，它<strong>必须</strong>断开客户端的网络连接，认为网络连接已断开 [MQTT-3.1.2-24]。</p>
<p>客户端发送了PINGREQ报文之后，如果在合理的时间内仍没有收到PINGRESP报文，它<strong>应该</strong>关闭到服务端的网络连接。</p>
<p>保持连接的值为零表示关闭保持连接功能。这意味着，服务端不需要因为客户端不活跃而断开连接。注意：不管保持连接的值是多少，任何时候，只要服务端认为客户端是不活跃或无响应的，可以断开客户端的连接。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>保持连接的实际值是由应用指定的，一般是几分钟。允许的最大值是18小时12分15秒。</p>
</blockquote>
<h4 id="可变报头非规范示例"><a href="#可变报头非规范示例" class="headerlink" title="可变报头非规范示例"></a>可变报头非规范示例</h4><h5 id="图例-3-6-可变报头非规范示例"><a href="#图例-3-6-可变报头非规范示例" class="headerlink" title="图例 3.6 -可变报头非规范示例"></a>图例 3.6 -可变报头非规范示例</h5><p><img src="/2018/12/16/MTQQ-介绍/figure0306.png" alt="figure-3.6"></p>
<h3 id="3-1-3-有效载荷-Payload"><a href="#3-1-3-有效载荷-Payload" class="headerlink" title="3.1.3 有效载荷 Payload"></a>3.1.3 有效载荷 Payload</h3><p>CONNECT报文的有效载荷（payload）包含一个或多个以长度为前缀的字段，可变报头中的标志决定是否包含这些字段。如果包含的话，<strong>必须</strong>按这个顺序出现：客户端标识符，遗嘱主题，遗嘱消息，用户名，密码 [MQTT-3.1.3-1]。</p>
<h4 id="客户端标识符-Client-Identifier"><a href="#客户端标识符-Client-Identifier" class="headerlink" title="客户端标识符 Client Identifier"></a>客户端标识符 Client Identifier</h4><p>服务端使用客户端标识符 (ClientId) 识别客户端。连接服务端的每个客户端都有唯一的客户端标识符（ClientId）。客户端和服务端都必须使用ClientId识别两者之间的MQTT会话相关的状态 [MQTT-3.1.3-2]。</p>
<p>客户端标识符 (ClientId) <strong>必须</strong>存在而且<strong>必须</strong>是CONNECT报文有效载荷的第一个字段 [MQTT-3.1.3-3]。</p>
<p>客户端标识符<strong>必须</strong>是1.5.3节定义的UTF-8编码字符串 [MQTT-3.1.3-4]。</p>
<p>服务端<strong>必须</strong>允许1到23个字节长的UTF-8编码的客户端标识符，客户端标识符只能包含这些字符：“0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ”（大写字母，小写字母和数字）[MQTT-3.1.3-5]。</p>
<p>服务端<strong>可以</strong>允许编码后超过23个字节的客户端标识符 (ClientId)。服务端<strong>可以</strong>允许包含不是上面列表字符的客户端标识符 (ClientId)。</p>
<p>服务端<strong>可以</strong>允许客户端提供一个零字节的客户端标识符 (ClientId) ，如果这样做了，服务端<strong>必须</strong>将这看作特殊情况并分配唯一的客户端标识符给那个客户端。然后它<strong>必须</strong>假设客户端提供了那个唯一的客户端标识符，正常处理这个CONNECT报文 [MQTT-3.1.3-6]。</p>
<p>如果客户端提供了一个零字节的客户端标识符，它<strong>必须</strong>同时将清理会话标志设置为1 [MQTT-3.1.3-7]。</p>
<p>如果客户端提供的ClientId为零字节且清理会话标志为0，服务端<strong>必须</strong>发送返回码为0x02（表示标识符不合格）的CONNACK报文响应客户端的CONNECT报文，然后关闭网络连接 [MQTT-3.1.3-8]。</p>
<p>如果服务端拒绝了这个ClientId，它<strong>必须</strong>发送返回码为0x02（表示标识符不合格）的CONNACK报文响应客户端的CONNECT报文，然后关闭网络连接 [MQTT-3.1.3-9]。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>客户端实现可以提供一个方便的方法用于生成随机的ClientId。当清理会话标志被设置为0时应该主动放弃使用这种方法。</p>
</blockquote>
<h4 id="遗嘱主题-Will-Topic"><a href="#遗嘱主题-Will-Topic" class="headerlink" title="遗嘱主题 Will Topic"></a>遗嘱主题 Will Topic</h4><p>如果遗嘱标志被设置为1，有效载荷的下一个字段是遗嘱主题（Will Topic）。遗嘱主题<strong>必须</strong>是 1.5.3节定义的UTF-8编码字符串 [MQTT-3.1.3-10]。</p>
<h4 id="遗嘱消息-Will-Message"><a href="#遗嘱消息-Will-Message" class="headerlink" title="遗嘱消息 Will Message"></a>遗嘱消息 Will Message</h4><p>如果遗嘱标志被设置为1，有效载荷的下一个字段是遗嘱消息。遗嘱消息定义了将被发布到遗嘱主题的应用消息，见3.1.2.5节的描述。这个字段由一个两字节的长度和遗嘱消息的有效载荷组成，表示为零字节或多个字节序列。长度给出了跟在后面的数据的字节数，不包含长度字段本身占用的两个字节。</p>
<p>遗嘱消息被发布到遗嘱主题时，它的有效载荷只包含这个字段的数据部分，不包含开头的两个长度字节。</p>
<h4 id="用户名-User-Name"><a href="#用户名-User-Name" class="headerlink" title="用户名 User Name"></a>用户名 User Name</h4><p>如果用户名（User Name）标志被设置为1，有效载荷的下一个字段就是它。用户名<strong>必须</strong>是 1.5.3节定义的UTF-8编码字符串 [MQTT-3.1.3-11]。服务端可以将它用于身份验证和授权。</p>
<h4 id="密码-Password"><a href="#密码-Password" class="headerlink" title="密码 Password"></a>密码 Password</h4><p>如果密码（Password）标志被设置为1，有效载荷的下一个字段就是它。密码字段包含一个两字节的长度字段，长度表示二进制数据的字节数（不包含长度字段本身占用的两个字节），后面跟着0到65535字节的二进制数据。</p>
<h5 id="图例-3-7-密码字节"><a href="#图例-3-7-密码字节" class="headerlink" title="图例 3.7 - 密码字节"></a>图例 3.7 - 密码字节</h5><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong> - <strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>byte 1</td>
<td>数据长度 MSB</td>
</tr>
<tr>
<td>byte 2</td>
<td>数据长度 LSB</td>
</tr>
<tr>
<td>byte 3 ….</td>
<td>如果长度大于0，这里就是数据部分</td>
</tr>
</tbody>
</table>
<h3 id="3-1-4-响应-Response"><a href="#3-1-4-响应-Response" class="headerlink" title="3.1.4 响应 Response"></a>3.1.4 响应 Response</h3><p>注意：服务器可以在同一个TCP端口或其他网络端点上支持多种协议（包括本协议的早期版本）。如果服务器确定协议是MQTT 3.1.1，那么它按照下面的方法验证连接请求。</p>
<ol>
<li>网络连接建立后，如果服务端在合理的时间内没有收到CONNECT报文，服务端<strong>应该</strong>关闭这个连接。</li>
<li>服务端<strong>必须</strong>按照3.1节的要求验证CONNECT报文，如果报文不符合规范，服务端不发送CONNACK报文直接关闭网络连接 [MQTT-3.1.4-1]。</li>
<li>服务端<strong>可以</strong>检查CONNECT报文的内容是不是满足任何进一步的限制，<strong>可以</strong>执行身份验证和授权检查。如果任何一项检查没通过，按照3.2节的描述，它<strong>应该</strong>发送一个适当的、返回码非零的CONNACK响应，并且<strong>必须</strong>关闭这个网络连接。</li>
</ol>
<p>如果验证成功，服务端会执行下列步骤。</p>
<ol>
<li>如果ClientId表明客户端已经连接到这个服务端，那么服务端<strong>必须</strong>断开原有的客户端连接 [MQTT-3.1.4-2]。</li>
<li>服务端<strong>必须</strong>按照 3.1.2.4节的描述执行清理会话的过程 [MQTT-3.1.4-3]。</li>
<li>服务端<strong>必须</strong>发送返回码为零的CONNACK报文作为CONNECT报文的确认响应 [MQTT-3.1.4-4]。</li>
<li>开始消息分发和保持连接状态监视。</li>
</ol>
<p>允许客户端在发送CONNECT报文之后立即发送其它的控制报文；客户端不需要等待服务端的CONNACK报文。如果服务端拒绝了CONNECT，它<strong>不能</strong>处理客户端在CONNECT报文之后发送的任何数据 [MQTT-3.1.4-5]。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>客户端通常会等待一个CONNACK报文。然而客户端有权在收到CONNACK之前发送控制报文，由于不需要维持连接状态，这可以简化客户端的实现。</p>
</blockquote>
<h2 id="3-2-CONNACK-–-确认连接请求"><a href="#3-2-CONNACK-–-确认连接请求" class="headerlink" title="3.2 CONNACK – 确认连接请求"></a>3.2 CONNACK – 确认连接请求</h2><p>服务端发送CONNACK报文响应从客户端收到的CONNECT报文。服务端发送给客户端的第一个报文<strong>必须</strong>是CONNACK [MQTT-3.2.0-1]。</p>
<p>如果客户端在合理的时间内没有收到服务端的CONNACK报文，客户端<strong>应该</strong>关闭网络连接。<em>合理</em> 的时间取决于应用的类型和通信基础设施。</p>
<h3 id="3-2-1-固定报头"><a href="#3-2-1-固定报头" class="headerlink" title="3.2.1 固定报头"></a>3.2.1 固定报头</h3><p>固定报头的格式见 <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0302-CONNACK.html#_Figure_3.8_%E2%80%93" target="_blank" rel="noopener">图例 3.8 – CONNACK 报文固定报头</a> 的描述。</p>
<h5 id="图例-3-8-–-CONNACK-报文固定报头"><a href="#图例-3-8-–-CONNACK-报文固定报头" class="headerlink" title="图例 3.8 – CONNACK 报文固定报头"></a>图例 3.8 – CONNACK 报文固定报头</h5><table><br>    <tr><br>        <td><center><strong>Bit</strong></center></td><br>        <td><center><strong>7</strong></center></td><br>        <td><center><strong>6</strong></center></td><br>        <td><center><strong>5</strong></center></td><br>        <td><center><strong>4</strong></center></td><br>        <td><center><strong>3</strong></center></td><br>        <td><center><strong>2</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>   <tr><br>           <td colspan="1"><center>byte 1</center></td><br>        <td colspan="4"><center>MQTT报文类型 (2)</center></td><br>        <td colspan="4"><center>Reserved 保留位</center></td><br>   </tr><br>    <tr><br>           <td><center><strong> </strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>     <tr><br>           <td colspan="1"><center>byte 2…</center></td><br>        <td colspan="8"><center>剩余长度</center></td><br>   </tr><br></table>

<p><strong>剩余长度字段</strong>表示可变报头的长度。对于CONNACK报文这个值等于2。</p>
<h3 id="3-2-2-可变报头"><a href="#3-2-2-可变报头" class="headerlink" title="3.2.2 可变报头"></a>3.2.2 可变报头</h3><p>可变报头的格式见 <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0302-CONNACK.html#_%E5%9B%BE%E4%BE%8B_3.9_%E2%80%93CONNACK%E6%8A%A5%E6%96%87%E5%8F%AF%E5%8F%98%E6%8A%A5%E5%A4%B4" target="_blank" rel="noopener">图例 3.9 –CONNACK报文可变报头</a> 的描述。</p>
<h5 id="图例-3-9-–CONNACK报文可变报头"><a href="#图例-3-9-–CONNACK报文可变报头" class="headerlink" title="图例 3.9 –CONNACK报文可变报头"></a>图例 3.9 –CONNACK报文可变报头</h5><table><br>    <tr><br>        <td><center><strong>描述</strong></center></td><br>        <td><center><strong>7</strong></center></td><br>        <td><center><strong>6</strong></center></td><br>        <td><center><strong>5</strong></center></td><br>        <td><center><strong>4</strong></center></td><br>        <td><center><strong>3</strong></center></td><br>        <td><center><strong>2</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>   <tr><br>           <td colspan="1"><center>连接确认标志</center></td><br>        <td colspan="7"><center>Reserved 保留位</center></td><br>        <td colspan="1"><center>SP1</center></td><br>   </tr><br>    <tr><br>           <td><center><strong>byte 1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>   </tr><br>     <tr><br>        <td colspan="9"><center>连接返回码</center></td><br>   </tr><br>    <tr><br>           <td><center><strong>byte 2</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>   </tr><br></table>

<h4 id="连接确认标志-Connect-Acknowledge-Flags"><a href="#连接确认标志-Connect-Acknowledge-Flags" class="headerlink" title="连接确认标志 Connect Acknowledge Flags"></a>连接确认标志 Connect Acknowledge Flags</h4><p>第1个字节是 <em>连接确认标志</em>，位7-1是保留位且<strong>必须</strong>设置为0。 第0 (SP)位 是当前会话（Session Present）标志。</p>
<h4 id="当前会话-Session-Present"><a href="#当前会话-Session-Present" class="headerlink" title="当前会话 Session Present"></a>当前会话 Session Present</h4><p><strong>位置：</strong>连接确认标志的第0位。</p>
<p>如果服务端收到清理会话（CleanSession）标志为1的连接，除了将CONNACK报文中的返回码设置为0之外，还<strong>必须</strong>将CONNACK报文中的当前会话设置（Session Present）标志为0 [MQTT-3.2.2-1]。</p>
<p>如果服务端收到一个CleanSession为0的连接，当前会话标志的值取决于服务端是否已经保存了ClientId对应客户端的会话状态。如果服务端已经保存了会话状态，它<strong>必须</strong>将CONNACK报文中的当前会话标志设置为1 [MQTT-3.2.2-2]。如果服务端没有已保存的会话状态，它<strong>必须</strong>将CONNACK报文中的当前会话设置为0。还需要将CONNACK报文中的返回码设置为0 [MQTT-3.2.2-3]。</p>
<p>当前会话标志使服务端和客户端在是否有已存储的会话状态上保持一致。</p>
<p>一旦完成了会话的初始化设置，已经保存会话状态的客户端将期望服务端维持它存储的会话状态。如果客户端从服务端收到的当前的值与预期的不同，客户端可以选择继续这个会话或者断开连接。客户端可以丢弃客户端和服务端之间的会话状态，方法是，断开连接，将清理会话标志设置为1，再次连接，然后再次断开连接。</p>
<p>如果服务端发送了一个包含非零返回码的CONNACK报文，它<strong>必须</strong>将当前会话标志设置为0 [MQTT-3.2.2-4]。</p>
<h4 id="连接返回码-Connect-Return-code"><a href="#连接返回码-Connect-Return-code" class="headerlink" title="连接返回码 Connect Return code"></a>连接返回码 Connect Return code</h4><p><strong>位置：</strong>可变报头的第2个字节。</p>
<p>连接返回码字段使用一个字节的无符号值，在 <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0302-CONNACK.html#_%E8%A1%A8%E6%A0%BC_3.1_%E2%80%93%E8%BF%9E%E6%8E%A5%E8%BF%94%E5%9B%9E%E7%A0%81%E7%9A%84%E5%80%BC" target="_blank" rel="noopener">表格 3.1 –连接返回码的值</a> 中列出。如果服务端收到一个合法的CONNECT报文，但出于某些原因无法处理它，服务端应该尝试发送一个包含非零返回码（表格中的某一个）的CONNACK报文。如果服务端发送了一个包含非零返回码的CONNACK报文，那么它<strong>必须</strong>关闭网络连接 [MQTT-3.2.2-5].。</p>
<h5 id="表格-3-1-–连接返回码的值"><a href="#表格-3-1-–连接返回码的值" class="headerlink" title="表格 3.1 –连接返回码的值"></a>表格 3.1 –连接返回码的值</h5><table>
<thead>
<tr>
<th><strong>值</strong></th>
<th><strong>返回码响应</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0x00连接已接受</td>
<td>连接已被服务端接受</td>
</tr>
<tr>
<td>1</td>
<td>0x01连接已拒绝，不支持的协议版本</td>
<td>服务端不支持客户端请求的MQTT协议级别</td>
</tr>
<tr>
<td>2</td>
<td>0x02连接已拒绝，不合格的客户端标识符</td>
<td>客户端标识符是正确的UTF-8编码，但服务端不允许使用</td>
</tr>
<tr>
<td>3</td>
<td>0x03连接已拒绝，服务端不可用</td>
<td>网络连接已建立，但MQTT服务不可用</td>
</tr>
<tr>
<td>4</td>
<td>0x04连接已拒绝，无效的用户名或密码</td>
<td>用户名或密码的数据格式无效</td>
</tr>
<tr>
<td>5</td>
<td>0x05连接已拒绝，未授权</td>
<td>客户端未被授权连接到此服务器</td>
</tr>
<tr>
<td>6-255</td>
<td></td>
<td>保留</td>
</tr>
</tbody>
</table>
<p>如果认为上表中的所有连接返回码都不太合适，那么服务端<strong>必须</strong>关闭网络连接，不需要发送CONNACK报文 [MQTT-3.2.2-6]。</p>
<h3 id="3-2-3-有效载荷"><a href="#3-2-3-有效载荷" class="headerlink" title="3.2.3 有效载荷"></a>3.2.3 有效载荷</h3><p>CONNACK报文没有有效载荷。</p>
<h2 id="3-3-PUBLISH-–-发布消息"><a href="#3-3-PUBLISH-–-发布消息" class="headerlink" title="3.3 PUBLISH – 发布消息"></a>3.3 PUBLISH – 发布消息</h2><p>PUBLISH控制报文是指从客户端向服务端或者服务端向客户端传输一个应用消息。</p>
<h3 id="3-3-1-固定报头"><a href="#3-3-1-固定报头" class="headerlink" title="3.3.1 固定报头"></a>3.3.1 固定报头</h3><p><a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0303-PUBLISH.html#_%E5%9B%BE%E4%BE%8B_3.10_%E2%80%93" target="_blank" rel="noopener">图例 3.10 – PUBLISH报文固定报头</a>描述了固定报头的格式</p>
<h5 id="图例-3-10-–-PUBLISH报文固定报头"><a href="#图例-3-10-–-PUBLISH报文固定报头" class="headerlink" title="图例 3.10 – PUBLISH报文固定报头"></a>图例 3.10 – PUBLISH报文固定报头</h5><table><br>    <tr><br>        <td><center><strong>描述</strong></center></td><br>        <td><center><strong>7</strong></center></td><br>        <td><center><strong>6</strong></center></td><br>        <td><center><strong>5</strong></center></td><br>        <td><center><strong>4</strong></center></td><br>        <td><center><strong>3</strong></center></td><br>        <td><center><strong>2</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>   </tr><br>    <tr><br>        <td><center><strong>byte 1</strong></center></td><br>        <td colspan="4"><center>MQTT控制报文类型 (3)</center></td><br>        <td><center><strong>DUP</strong></center></td><br>        <td><center><strong>QoS-H</strong></center></td><br>        <td><center><strong>QoS-</strong></center></td><br>        <td><center><strong>RETAIN</strong></center></td><br>   </tr><br>    <tr><br>           <td><center><strong> </strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>0</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>1</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>        <td><center><strong>X</strong></center></td><br>   </tr><br>    <tr><br>           <td><center><strong>byte 2</strong></center></td><br>        <td colspan="8"><center>剩余长度</center></td><br>   </tr><br></table>

<h4 id="重发标志-DUP"><a href="#重发标志-DUP" class="headerlink" title="重发标志 DUP"></a>重发标志 DUP</h4><p><strong>位置：</strong>第1个字节，第3位</p>
<p>如果DUP标志被设置为0，表示这是客户端或服务端第一次请求发送这个PUBLISH报文。如果DUP标志被设置为1，表示这可能是一个早前报文请求的重发。</p>
<p>客户端或服务端请求重发一个PUBLISH报文时，<strong>必须</strong>将DUP标志设置为1 [MQTT-3.3.1.-1].。对于QoS 0的消息，DUP标志<strong>必须</strong>设置为0 [MQTT-3.3.1-2]。</p>
<p>服务端发送PUBLISH报文给订阅者时，收到（入站）的PUBLISH报文的DUP标志的值不会被传播。发送（出站）的PUBLISH报文与收到（入站）的PUBLISH报文中的DUP标志是独立设置的，它的值<strong>必须</strong>单独的根据发送（出站）的PUBLISH报文是否是一个重发来确定 [MQTT-3.3.1-3]。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>接收者收到一个DUP标志为1的控制报文时，不能假设它看到了一个这个报文之前的一个副本。</p>
<p><strong>非规范评注</strong></p>
<p>需要特别指出的是，DUP标志关注的是控制报文本身，与它包含的应用消息无关。当使用QoS 1时，客户端可能会收到一个DUP标志为0的PUBLISH报文，这个报文包含一个它之前收到过的应用消息的副本，但是用的是不同的报文标识符。 2.3.1节提供了有关报文标识符的更多信息。</p>
</blockquote>
<h4 id="服务质量等级-QoS"><a href="#服务质量等级-QoS" class="headerlink" title="服务质量等级 QoS"></a>服务质量等级 QoS</h4><p><strong>位置：</strong>第1个字节，第2-1位。</p>
<p>这个字段表示应用消息分发的服务质量等级保证。服务质量等级在 <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0303-PUBLISH.html#_%E8%A1%A8%E6%A0%BC_3.2_-%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F%E5%AE%9A%E4%B9%89" target="_blank" rel="noopener">表格 3.2 -服务质量定义</a> 中列出。</p>
<h5 id="表格-3-2-服务质量定义"><a href="#表格-3-2-服务质量定义" class="headerlink" title="表格 3.2 -服务质量定义"></a>表格 3.2 -服务质量定义</h5><table>
<thead>
<tr>
<th><strong>QoS值</strong></th>
<th><strong>Bit 2</strong></th>
<th><strong>Bit 1</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>最多分发一次</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>至少分发一次</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>0</td>
<td>只分发一次</td>
</tr>
<tr>
<td>-</td>
<td>1</td>
<td>1</td>
<td>保留位</td>
</tr>
</tbody>
</table>
<p>PUBLISH报文<strong>不能</strong>将QoS所有的位设置为1。如果服务端或客户端收到QoS所有位都为1的PUBLISH报文，它<strong>必须</strong>关闭网络连接 [MQTT-3.3.1-4]。</p>
<h4 id="保留标志-RETAIN"><a href="#保留标志-RETAIN" class="headerlink" title="保留标志 RETAIN"></a>保留标志 RETAIN</h4><p><strong>位置：</strong>第1个字节，第0位。</p>
<p>如果客户端发给服务端的PUBLISH报文的保留（RETAIN）标志被设置为1，服务端<strong>必须</strong>存储这个应用消息和它的服务质量等级（QoS），以便它可以被分发给未来的主题名匹配的订阅者 [MQTT-3.3.1-5]。一个新的订阅建立时，对每个匹配的主题名，如果存在最近保留的消息，它<strong>必须</strong>被发送给这个订阅者 [MQTT-3.3.1-6]。如果服务端收到一条保留（RETAIN）标志为1的QoS 0消息，它<strong>必须</strong>丢弃之前为那个主题保留的任何消息。它<strong>应该</strong>将这个新的QoS 0消息当作那个主题的新保留消息，但是任何时候都<strong>可以</strong>选择丢弃它 — 如果这种情况发生了，那个主题将没有保留消息 [MQTT-3.3.1-7]。有关存储状态的更多信息见 4.1节。</p>
<p>服务端发送PUBLISH报文给客户端时，如果消息是作为客户端一个新订阅的结果发送，它<strong>必须</strong>将报文的保留标志设为1 [MQTT-3.3.1-8]。当一个PUBLISH报文发送给客户端是因为匹配一个已建立的订阅时，服务端<strong>必须</strong>将保留标志设为0，不管它收到的这个消息中保留标志的值是多少 [MQTT-3.3.1-9]。</p>
<p>保留标志为1且有效载荷为零字节的PUBLISH报文会被服务端当作正常消息处理，它会被发送给订阅主题匹配的客户端。此外，同一个主题下任何现存的保留消息必须被移除，因此这个主题之后的任何订阅者都不会收到一个保留消息 [MQTT-3.3.1-10]。<em>当作正常</em> 意思是现存的客户端收到的消息中保留标志未被设置。服务端<strong>不能</strong>存储零字节的保留消息 [MQTT-3.3.1-11]。</p>
<p>如果客户端发给服务端的PUBLISH报文的保留标志位0，服务端<strong>不能</strong>存储这个消息也<strong>不能</strong>移除或替换任何现存的保留消息 [MQTT-3.3.1-12]。</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>对于发布者不定期发送状态消息这个场景，保留消息很有用。新的订阅者将会收到最近的状态。</p>
</blockquote>
<p><strong>剩余长度字段</strong></p>
<p>等于可变报头的长度加上有效载荷的长度。</p>
<h3 id="3-3-2-可变报头"><a href="#3-3-2-可变报头" class="headerlink" title="3.3.2 可变报头"></a>3.3.2 可变报头</h3><p>可变报头按顺序包含主题名和报文标识符。</p>
<h4 id="主题名-Topic-Name"><a href="#主题名-Topic-Name" class="headerlink" title="主题名 Topic Name"></a>主题名 Topic Name</h4><p>主题名（Topic Name）用于识别有效载荷数据应该被发布到哪一个信息通道。</p>
<p>主题名<strong>必须</strong>是PUBLISH报文可变报头的第一个字段。它<strong>必须</strong>是 1.5.3节定义的UTF-8编码的字符串 [MQTT-3.3.2-1]。</p>
<p>PUBLISH报文中的主题名<strong>不能</strong>包含通配符 [MQTT-3.3.2-2]。</p>
<p>服务端发送给订阅客户端的PUBLISH报文的主题名<strong>必须</strong>匹配该订阅的主题过滤器（根据 4.7节定义的匹配过程）[MQTT-3.3.2-3]。</p>
<h4 id="报文标识符-Packet-Identifier"><a href="#报文标识符-Packet-Identifier" class="headerlink" title="报文标识符 Packet Identifier"></a>报文标识符 Packet Identifier</h4><p>只有当QoS等级是1或2时，报文标识符（Packet Identifier）字段才能出现在PUBLISH报文中。2.3.1节提供了有关报文标识符的更多信息。</p>
<h4 id="可变报头非规范示例-1"><a href="#可变报头非规范示例-1" class="headerlink" title="可变报头非规范示例"></a>可变报头非规范示例</h4><p><a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0303-PUBLISH.html#_Figure_3.11_-" target="_blank" rel="noopener">图例 3.11 – PUBLISH报文可变报头非规范示例</a> 举例说明了 <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/0303-PUBLISH.html#_%E8%A1%A8%E6%A0%BC_3.3_-" target="_blank" rel="noopener">表格 3.3 - PUBLISH报文非规范示例</a> 中简要描述的PUBLISH报文的可变报头。</p>
<h5 id="表格-3-3-PUBLISH报文非规范示例"><a href="#表格-3-3-PUBLISH报文非规范示例" class="headerlink" title="表格 3.3 - PUBLISH报文非规范示例"></a>表格 3.3 - PUBLISH报文非规范示例</h5><table>
<thead>
<tr>
<th><strong>Field</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>主题名</td>
<td>a/b</td>
</tr>
<tr>
<td>报文标识符</td>
<td>10</td>
</tr>
</tbody>
</table>
<h5 id="图例-3-11-–-PUBLISH报文可变报头非规范示例"><a href="#图例-3-11-–-PUBLISH报文可变报头非规范示例" class="headerlink" title="图例 3.11 – PUBLISH报文可变报头非规范示例"></a>图例 3.11 – PUBLISH报文可变报头非规范示例</h5><table>
<thead>
<tr>
<th></th>
<th><strong>描述</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Topic Name 主题名</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 1</td>
<td>Length MSB (0)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>Length LSB (3)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>byte 3</td>
<td>‘a’ (0x61)</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>byte 4</td>
<td>‘/’ (0x2F)</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>byte 5</td>
<td>‘b’ (0x62)</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>报文标识符</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 6</td>
<td>报文标识符 MSB (0)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 7</td>
<td>报文标识符 LSB (10)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>示例中的主题名为 “a/b”，长度等于3，报文标识符为 “10”</p>
<h3 id="3-3-3-有效载荷"><a href="#3-3-3-有效载荷" class="headerlink" title="3.3.3 有效载荷"></a>3.3.3 有效载荷</h3><p>有效载荷包含将被发布的应用消息。数据的内容和格式是应用特定的。有效载荷的长度这样计算：用固定报头中的剩余长度字段的值减去可变报头的长度。包含零长度有效载荷的PUBLISH报文是合法的。</p>
<h3 id="3-3-4-响应"><a href="#3-3-4-响应" class="headerlink" title="3.3.4 响应"></a>3.3.4 响应</h3><p>PUBLISH报文的接收者<strong>必须</strong>按照根据PUBLISH报文中的QoS等级发送响应，见下面表格的描述 [MQTT-3.3.4-1]。</p>
<h5 id="表格-3-4-–-PUBLISH报文的预期响应"><a href="#表格-3-4-–-PUBLISH报文的预期响应" class="headerlink" title="表格 3.4 – PUBLISH报文的预期响应"></a>表格 3.4 – PUBLISH报文的预期响应</h5><table>
<thead>
<tr>
<th><strong>服务质量等级</strong></th>
<th><strong>预期响应</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>QoS 0</td>
<td>无响应</td>
</tr>
<tr>
<td>QoS 1</td>
<td>PUBACK报文</td>
</tr>
<tr>
<td>QoS 2</td>
<td>PUBREC报文</td>
</tr>
</tbody>
</table>
<h3 id="3-3-5-动作-Actions"><a href="#3-3-5-动作-Actions" class="headerlink" title="3.3.5 动作 Actions"></a>3.3.5 动作 Actions</h3><p>客户端使用PUBLISH报文发送应用消息给服务端，目的是分发到其它订阅匹配的客户端。</p>
<p>服务端使用PUBLISH报文发送应用消息给每一个订阅匹配的客户端。</p>
<p>客户端使用带通配符的主题过滤器请求订阅时，客户端的订阅可能会重复，因此发布的消息可能会匹配多个过滤器。对于这种情况，服务端<strong>必须</strong>将消息分发给所有订阅匹配的QoS等级最高的客户端 [MQTT-3.3.5-1]。服务端之后可以按照订阅的QoS等级，分发消息的副本给每一个匹配的订阅者。</p>
<p>收到一个PUBLISH报文时，接收者的动作取决于4.3节描述的QoS等级。</p>
<p>如果服务端实现不授权某个客户端发布PUBLISH报文，它没有办法通知那个客户端。它<strong>必须</strong>按照正常的QoS规则发送一个正面的确认，或者关闭网络连接 [MQTT-3.3.5-2]。</p>
<blockquote>
<p>MQTT 原文文献:<a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html</a></p>
<p>MQTT 中文版:<a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html" target="_blank" rel="noopener">https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/01-Introduction.html</a></p>
</blockquote>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/14/UIView和-CALayer/" rel="next" title="UIView和 CALayer">
                <i class="fa fa-chevron-left"></i> UIView和 CALayer
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/01/iOS-CALayer-教程-入门/" rel="prev" title="iOS CALayer 教程:入门">
                iOS CALayer 教程:入门 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Wong</p>
              <p class="site-description motion-element" itemprop="description">别在机会来临之时却无法握住。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-MQTT控制报文的结构-Structure-of-an-MQTT-Control-Packet"><span class="nav-number">1.</span> <span class="nav-text">2.1 MQTT控制报文的结构 Structure of an MQTT Control Packet</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#MQTT控制报文的结构"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">MQTT控制报文的结构</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-固定报头-Fixed-header"><span class="nav-number">2.</span> <span class="nav-text">2.2 固定报头 Fixed header</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#固定报头的格式"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">固定报头的格式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-MQTT控制报文的类型-MQTT-Control-Packet-type"><span class="nav-number">2.1.</span> <span class="nav-text">2.2.1 MQTT控制报文的类型 MQTT Control Packet type</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#控制报文的类型"><span class="nav-number">2.1.0.1.</span> <span class="nav-text">控制报文的类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-标志-Flags"><span class="nav-number">2.2.</span> <span class="nav-text">2.2.2 标志 Flags</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#标志位-Flag-Bits"><span class="nav-number">2.2.0.1.</span> <span class="nav-text">标志位 Flag Bits</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-剩余长度-Remaining-Length"><span class="nav-number">2.3.</span> <span class="nav-text">2.2.3 剩余长度 Remaining Length</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-2-4剩余长度字段的大小-Size-of-Remaining-Length-field"><span class="nav-number">2.3.0.1.</span> <span class="nav-text">表格 2.4剩余长度字段的大小 Size of Remaining Length field</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-可变报头-Variable-header"><span class="nav-number">3.</span> <span class="nav-text">2.3 可变报头 Variable header</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-2-3-报文标识符字节-Packet-Identifier-bytes"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">图例 2.3 -报文标识符字节 Packet Identifier bytes</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-2-5-包含报文标识符的控制报文-Control-Packets-that-contain-a-Packet-Identifier"><span class="nav-number">3.0.0.2.</span> <span class="nav-text">表格 2.5 -包含报文标识符的控制报文 Control Packets that contain a Packet Identifier</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-有效载荷-Payload"><span class="nav-number">4.</span> <span class="nav-text">2.4 有效载荷 Payload</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-2-6-–-包含有效载荷的控制报文-Control-Packets-that-contain-a-Payload"><span class="nav-number">4.0.0.1.</span> <span class="nav-text">表格 2.6 – 包含有效载荷的控制报文 Control Packets that contain a Payload</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-CONNECT-–-连接服务端"><span class="nav-number">5.</span> <span class="nav-text">3.1 CONNECT – 连接服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-固定报头-Fixed-header"><span class="nav-number">5.1.</span> <span class="nav-text">3.1.1 固定报头 Fixed header</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-1-–CONNECT报文的固定报头"><span class="nav-number">5.1.0.1.</span> <span class="nav-text">图例 3.1 –CONNECT报文的固定报头</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#剩余长度字段"><span class="nav-number">5.2.</span> <span class="nav-text">剩余长度字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-可变报头-Variable-header"><span class="nav-number">5.3.</span> <span class="nav-text">3.1.2 可变报头 Variable header</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#协议名-Protocol-Name"><span class="nav-number">5.3.1.</span> <span class="nav-text">协议名 Protocol Name</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-2-协议名字节构成"><span class="nav-number">5.3.1.1.</span> <span class="nav-text">图例 3.2 -协议名字节构成</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#协议级别-Protocol-Level"><span class="nav-number">5.3.2.</span> <span class="nav-text">协议级别 Protocol Level</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-3-Protocol-Level-byte协议级别字节构成"><span class="nav-number">5.3.2.1.</span> <span class="nav-text">图例 3.3 - Protocol Level byte协议级别字节构成</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接标志-Connect-Flags"><span class="nav-number">5.3.3.</span> <span class="nav-text">连接标志 Connect Flags</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-4-连接标志位"><span class="nav-number">5.3.3.1.</span> <span class="nav-text">图例 3.4 -连接标志位</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#清理会话-Clean-Session"><span class="nav-number">5.3.4.</span> <span class="nav-text">清理会话 Clean Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遗嘱标志-Will-Flag"><span class="nav-number">5.3.5.</span> <span class="nav-text">遗嘱标志 Will Flag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遗嘱QoS-Will-QoS"><span class="nav-number">5.3.6.</span> <span class="nav-text">遗嘱QoS Will QoS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遗嘱保留-Will-Retain"><span class="nav-number">5.3.7.</span> <span class="nav-text">遗嘱保留 Will Retain</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户名标志-User-Name-Flag"><span class="nav-number">5.3.8.</span> <span class="nav-text">用户名标志 User Name Flag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#密码标志-Password-Flag"><span class="nav-number">5.3.9.</span> <span class="nav-text">密码标志 Password Flag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保持连接-Keep-Alive"><span class="nav-number">5.3.10.</span> <span class="nav-text">保持连接 Keep Alive</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-5保持连接字节"><span class="nav-number">5.3.10.1.</span> <span class="nav-text">图例 3.5保持连接字节</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可变报头非规范示例"><span class="nav-number">5.3.11.</span> <span class="nav-text">可变报头非规范示例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-6-可变报头非规范示例"><span class="nav-number">5.3.11.1.</span> <span class="nav-text">图例 3.6 -可变报头非规范示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-有效载荷-Payload"><span class="nav-number">5.4.</span> <span class="nav-text">3.1.3 有效载荷 Payload</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端标识符-Client-Identifier"><span class="nav-number">5.4.1.</span> <span class="nav-text">客户端标识符 Client Identifier</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遗嘱主题-Will-Topic"><span class="nav-number">5.4.2.</span> <span class="nav-text">遗嘱主题 Will Topic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遗嘱消息-Will-Message"><span class="nav-number">5.4.3.</span> <span class="nav-text">遗嘱消息 Will Message</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户名-User-Name"><span class="nav-number">5.4.4.</span> <span class="nav-text">用户名 User Name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#密码-Password"><span class="nav-number">5.4.5.</span> <span class="nav-text">密码 Password</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-7-密码字节"><span class="nav-number">5.4.5.1.</span> <span class="nav-text">图例 3.7 - 密码字节</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-4-响应-Response"><span class="nav-number">5.5.</span> <span class="nav-text">3.1.4 响应 Response</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-CONNACK-–-确认连接请求"><span class="nav-number">6.</span> <span class="nav-text">3.2 CONNACK – 确认连接请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-固定报头"><span class="nav-number">6.1.</span> <span class="nav-text">3.2.1 固定报头</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-8-–-CONNACK-报文固定报头"><span class="nav-number">6.1.0.1.</span> <span class="nav-text">图例 3.8 – CONNACK 报文固定报头</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-可变报头"><span class="nav-number">6.2.</span> <span class="nav-text">3.2.2 可变报头</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-9-–CONNACK报文可变报头"><span class="nav-number">6.2.0.1.</span> <span class="nav-text">图例 3.9 –CONNACK报文可变报头</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接确认标志-Connect-Acknowledge-Flags"><span class="nav-number">6.2.1.</span> <span class="nav-text">连接确认标志 Connect Acknowledge Flags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#当前会话-Session-Present"><span class="nav-number">6.2.2.</span> <span class="nav-text">当前会话 Session Present</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接返回码-Connect-Return-code"><span class="nav-number">6.2.3.</span> <span class="nav-text">连接返回码 Connect Return code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-3-1-–连接返回码的值"><span class="nav-number">6.2.3.1.</span> <span class="nav-text">表格 3.1 –连接返回码的值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-有效载荷"><span class="nav-number">6.3.</span> <span class="nav-text">3.2.3 有效载荷</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-PUBLISH-–-发布消息"><span class="nav-number">7.</span> <span class="nav-text">3.3 PUBLISH – 发布消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-固定报头"><span class="nav-number">7.1.</span> <span class="nav-text">3.3.1 固定报头</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-10-–-PUBLISH报文固定报头"><span class="nav-number">7.1.0.1.</span> <span class="nav-text">图例 3.10 – PUBLISH报文固定报头</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重发标志-DUP"><span class="nav-number">7.1.1.</span> <span class="nav-text">重发标志 DUP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务质量等级-QoS"><span class="nav-number">7.1.2.</span> <span class="nav-text">服务质量等级 QoS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-3-2-服务质量定义"><span class="nav-number">7.1.2.1.</span> <span class="nav-text">表格 3.2 -服务质量定义</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保留标志-RETAIN"><span class="nav-number">7.1.3.</span> <span class="nav-text">保留标志 RETAIN</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-可变报头"><span class="nav-number">7.2.</span> <span class="nav-text">3.3.2 可变报头</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主题名-Topic-Name"><span class="nav-number">7.2.1.</span> <span class="nav-text">主题名 Topic Name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#报文标识符-Packet-Identifier"><span class="nav-number">7.2.2.</span> <span class="nav-text">报文标识符 Packet Identifier</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可变报头非规范示例-1"><span class="nav-number">7.2.3.</span> <span class="nav-text">可变报头非规范示例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-3-3-PUBLISH报文非规范示例"><span class="nav-number">7.2.3.1.</span> <span class="nav-text">表格 3.3 - PUBLISH报文非规范示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#图例-3-11-–-PUBLISH报文可变报头非规范示例"><span class="nav-number">7.2.3.2.</span> <span class="nav-text">图例 3.11 – PUBLISH报文可变报头非规范示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-有效载荷"><span class="nav-number">7.3.</span> <span class="nav-text">3.3.3 有效载荷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-响应"><span class="nav-number">7.4.</span> <span class="nav-text">3.3.4 响应</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#表格-3-4-–-PUBLISH报文的预期响应"><span class="nav-number">7.4.0.1.</span> <span class="nav-text">表格 3.4 – PUBLISH报文的预期响应</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-5-动作-Actions"><span class="nav-number">7.5.</span> <span class="nav-text">3.3.5 动作 Actions</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Wong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
